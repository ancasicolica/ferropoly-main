/* Ferropoly-Game V2.1.3, 28-12-2017, (c) Christian Kuster, CH-8342 Wernetshausen, christian@kusti.ch */

"use strict";var panels=["#panel-main","#panel-team","#panel-chancellery"];function showPanel(panel){panels.forEach(function(p){$(p).hide()}),$(panel).show()}var app=angular.module("summaryApp",[]);app.filter("amount",function(){return function(val){return _.isNumber(val)?val.toLocaleString("de-CH"):val}});var mapApiLoaded=!1;function initMap(){mapApiLoaded=!0}app.controller("summaryCtrl",["$scope","$http",function($scope,$http){console.log(info),$scope.info=info,$scope.markers=[],$scope.map;function setSaldo(list){if(list.length>0){list[0].saldo=list[0].transaction.amount;for(var i=1;i<list.length;i++)list[i].saldo=list[i-1].saldo+list[i].transaction.amount}}$scope.showTeam=function(team){$scope.team=team,showPanel("#panel-team"),$scope.teamProperties=_.filter($scope.info.properties,function(e){return e.gamedata.owner===team.teamId}),$scope.teamTransactions=_.filter($scope.info.teamTransactions,{teamId:team.teamId}),setSaldo($scope.teamTransactions),$scope.teamTravelLog=_.filter($scope.info.travelLog,{teamId:team.teamId}),$scope.teamTravelLog.forEach(function(t){t.propertyId&&(t.property=_.find($scope.info.properties,{uuid:t.propertyId}))}),drawTravelLog(),console.log($scope.teamTravelLog)},$scope.focusOnMap=function(travelLogEntry){console.log(travelLogEntry)},function(){if($scope.info.error)console.error(info.error);else{$scope.teams={};for(var i=0;i<info.teams.length;i++)$scope.teams[info.teams[i].teamId]=info.teams[i],$scope.teams[info.teams[i].teamId].gamedata={properties:[],buildings:0};for($scope.info.rankingList=_.orderBy($scope.info.rankingList,["asset"],["desc"]),i=0;i<$scope.info.rankingList.length;i++)$scope.info.rankingList[i].team=$scope.teams[$scope.info.rankingList[i]._id];for($scope.propertiesBought=0,$scope.propertiesFree=0,$scope.housesBuilt=0,i=0;i<$scope.info.properties.length;i++)$scope.info.properties[i].gamedata.owner&&($scope.propertiesBought++,$scope.housesBuilt+=$scope.info.properties[i].gamedata.buildings,$scope.teams[$scope.info.properties[i].gamedata.owner].gamedata.properties.push($scope.info.properties[i]),$scope.teams[$scope.info.properties[i].gamedata.owner].gamedata.buildings+=$scope.info.properties[i].gamedata.buildings);setSaldo($scope.info.chancellery)}}(),showPanel("#panel-main");function drawTravelLog(){$scope.markers.forEach(function(m){m.setMap(null)}),$scope.markers=[],$scope.bounds=new google.maps.LatLngBounds,$scope.teamProperties.forEach(function(p){var marker=new google.maps.Marker({position:{lat:parseFloat(p.location.position.lat),lng:parseFloat(p.location.position.lng)},map:$scope.map,title:"Hello World!"}),infowindow=new google.maps.InfoWindow({content:p.location.name});marker.addListener("click",function(){infowindow.open($scope.map,marker)}),$scope.bounds.extend(marker.getPosition()),$scope.markers.push(marker)}),$scope.map.fitBounds($scope.bounds);var cords=[];$scope.teamTravelLog.forEach(function(m){cords.push({lat:parseFloat(m.position.lat),lng:parseFloat(m.position.lng)})}),$scope.travelPath&&$scope.travelPath.setMap(null),$scope.travelPath=new google.maps.Polyline({path:cords,geodesic:!0,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:2}),$scope.travelPath.setMap($scope.map)}$(document).ready(function(){function initMap(){mapApiLoaded||_.delay(initMap,500),$scope.map=new google.maps.Map(document.getElementById("travel-map"),{zoom:10,center:{lat:47.320293,lng:8.794331}})}initMap()}),$scope.refreshMap=function(){_.delay(function(){console.log("Map resize triggered"),google.maps.event.trigger($scope.map,"resize"),drawTravelLog()},500)}}]);